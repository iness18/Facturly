<!DOCTYPE html>
<html>
  <head>
    <title>Nettoyage des doublons - Facturly</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #1a1a2e;
        color: white;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .button {
        background: #8b5cf6;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 5px;
      }
      .button:hover {
        background: #7c3aed;
      }
      .output {
        background: #16213e;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        white-space: pre-wrap;
      }
      .success {
        color: #10b981;
      }
      .error {
        color: #ef4444;
      }
      .info {
        color: #3b82f6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§¹ Nettoyage des activitÃ©s rÃ©centes</h1>
      <p>
        Cet outil permet de nettoyer les doublons dans vos activitÃ©s rÃ©centes.
      </p>

      <div>
        <button class="button" onclick="analyzeData()">
          ğŸ“Š Analyser les donnÃ©es
        </button>
        <button class="button" onclick="cleanupDuplicates()">
          ğŸ§¹ Nettoyer les doublons
        </button>
        <button class="button" onclick="clearAllTasks()">
          ğŸ—‘ï¸ Vider toutes les activitÃ©s
        </button>
      </div>

      <div id="output" class="output"></div>
    </div>

    <script>
      function log(message, type = "info") {
        const output = document.getElementById("output");
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === "success" ? "success" : type === "error" ? "error" : "info";
        output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        output.scrollTop = output.scrollHeight;
      }

      function analyzeData() {
        log("ğŸ” Analyse des donnÃ©es en cours...", "info");

        try {
          const recentTasks = JSON.parse(
            localStorage.getItem("facturly_recent_tasks") || "[]"
          );
          const invoices = JSON.parse(
            localStorage.getItem("facturly_invoices") || "[]"
          );

          log(`ğŸ“Š Statistiques actuelles:`, "info");
          log(`   â€¢ Total des tÃ¢ches rÃ©centes: ${recentTasks.length}`, "info");
          log(`   â€¢ Total des factures: ${invoices.length}`, "info");

          // Analyser les doublons
          const invoiceCreatedTasks = recentTasks.filter(
            (t) => t.type === "invoice_created"
          );
          const seenInvoices = new Set();
          let duplicates = 0;

          for (const task of invoiceCreatedTasks) {
            const match = task.description.match(/Facture ([^\s]+)/);
            if (match) {
              const invoiceNumber = match[1];
              if (seenInvoices.has(invoiceNumber)) {
                duplicates++;
              } else {
                seenInvoices.add(invoiceNumber);
              }
            }
          }

          log(
            `   â€¢ TÃ¢ches "Nouvelle facture crÃ©Ã©e": ${invoiceCreatedTasks.length}`,
            "info"
          );
          log(
            `   â€¢ Doublons dÃ©tectÃ©s: ${duplicates}`,
            duplicates > 0 ? "error" : "success"
          );

          if (duplicates > 0) {
            log(
              `âš ï¸  ${duplicates} doublons dÃ©tectÃ©s ! Utilisez le bouton "Nettoyer" pour les supprimer.`,
              "error"
            );
          } else {
            log(`âœ… Aucun doublon dÃ©tectÃ©.`, "success");
          }

          // Afficher les dÃ©tails
          log(`\nğŸ“‹ DÃ©tail des tÃ¢ches rÃ©centes:`, "info");
          recentTasks.forEach((task, index) => {
            log(`   ${index + 1}. ${task.title} - ${task.description}`, "info");
          });
        } catch (error) {
          log(`âŒ Erreur lors de l'analyse: ${error.message}`, "error");
        }
      }

      function cleanupDuplicates() {
        log("ğŸ§¹ Nettoyage des doublons en cours...", "info");

        try {
          const recentTasks = JSON.parse(
            localStorage.getItem("facturly_recent_tasks") || "[]"
          );
          const cleanedTasks = [];
          const seenInvoices = new Set();
          const seenClients = new Set();

          for (const task of recentTasks) {
            let shouldKeep = true;

            if (task.type === "invoice_created") {
              const invoiceNumberMatch =
                task.description.match(/Facture ([^\s]+)/);
              if (invoiceNumberMatch) {
                const invoiceNumber = invoiceNumberMatch[1];
                if (seenInvoices.has(invoiceNumber)) {
                  shouldKeep = false;
                  log(
                    `   ğŸ—‘ï¸  Suppression du doublon: ${task.description}`,
                    "info"
                  );
                } else {
                  seenInvoices.add(invoiceNumber);
                }
              }
            } else if (task.type === "client_added") {
              const clientNameMatch =
                task.description.match(/Client ([^]+) ajoutÃ©/);
              if (clientNameMatch) {
                const clientName = clientNameMatch[1];
                if (seenClients.has(clientName)) {
                  shouldKeep = false;
                  log(
                    `   ğŸ—‘ï¸  Suppression du doublon: ${task.description}`,
                    "info"
                  );
                } else {
                  seenClients.add(clientName);
                }
              }
            }

            if (shouldKeep) {
              cleanedTasks.push(task);
            }
          }

          localStorage.setItem(
            "facturly_recent_tasks",
            JSON.stringify(cleanedTasks)
          );

          const removedCount = recentTasks.length - cleanedTasks.length;
          log(`âœ… Nettoyage terminÃ© !`, "success");
          log(`   â€¢ TÃ¢ches avant: ${recentTasks.length}`, "info");
          log(`   â€¢ TÃ¢ches aprÃ¨s: ${cleanedTasks.length}`, "info");
          log(`   â€¢ Doublons supprimÃ©s: ${removedCount}`, "success");

          if (removedCount > 0) {
            log(
              `ğŸ”„ Rechargez la page du dashboard pour voir les changements.`,
              "info"
            );
          }
        } catch (error) {
          log(`âŒ Erreur lors du nettoyage: ${error.message}`, "error");
        }
      }

      function clearAllTasks() {
        if (
          confirm(
            "âš ï¸ ÃŠtes-vous sÃ»r de vouloir supprimer TOUTES les activitÃ©s rÃ©centes ?"
          )
        ) {
          localStorage.removeItem("facturly_recent_tasks");
          log(
            `ğŸ—‘ï¸ Toutes les activitÃ©s rÃ©centes ont Ã©tÃ© supprimÃ©es.`,
            "success"
          );
          log(
            `ğŸ”„ Rechargez la page du dashboard pour voir les changements.`,
            "info"
          );
        }
      }

      // Analyse automatique au chargement
      window.onload = () => {
        log("ğŸš€ Outil de nettoyage des doublons chargÃ©", "success");
        analyzeData();
      };
    </script>
  </body>
</html>
