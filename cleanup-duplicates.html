<!DOCTYPE html>
<html>
  <head>
    <title>Nettoyage des doublons - Facturly</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #1a1a2e;
        color: white;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .button {
        background: #8b5cf6;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 5px;
      }
      .button:hover {
        background: #7c3aed;
      }
      .output {
        background: #16213e;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        white-space: pre-wrap;
      }
      .success {
        color: #10b981;
      }
      .error {
        color: #ef4444;
      }
      .info {
        color: #3b82f6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🧹 Nettoyage des activités récentes</h1>
      <p>
        Cet outil permet de nettoyer les doublons dans vos activités récentes.
      </p>

      <div>
        <button class="button" onclick="analyzeData()">
          📊 Analyser les données
        </button>
        <button class="button" onclick="cleanupDuplicates()">
          🧹 Nettoyer les doublons
        </button>
        <button class="button" onclick="clearAllTasks()">
          🗑️ Vider toutes les activités
        </button>
      </div>

      <div id="output" class="output"></div>
    </div>

    <script>
      function log(message, type = "info") {
        const output = document.getElementById("output");
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === "success" ? "success" : type === "error" ? "error" : "info";
        output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        output.scrollTop = output.scrollHeight;
      }

      function analyzeData() {
        log("🔍 Analyse des données en cours...", "info");

        try {
          const recentTasks = JSON.parse(
            localStorage.getItem("facturly_recent_tasks") || "[]"
          );
          const invoices = JSON.parse(
            localStorage.getItem("facturly_invoices") || "[]"
          );

          log(`📊 Statistiques actuelles:`, "info");
          log(`   • Total des tâches récentes: ${recentTasks.length}`, "info");
          log(`   • Total des factures: ${invoices.length}`, "info");

          // Analyser les doublons
          const invoiceCreatedTasks = recentTasks.filter(
            (t) => t.type === "invoice_created"
          );
          const seenInvoices = new Set();
          let duplicates = 0;

          for (const task of invoiceCreatedTasks) {
            const match = task.description.match(/Facture ([^\s]+)/);
            if (match) {
              const invoiceNumber = match[1];
              if (seenInvoices.has(invoiceNumber)) {
                duplicates++;
              } else {
                seenInvoices.add(invoiceNumber);
              }
            }
          }

          log(
            `   • Tâches "Nouvelle facture créée": ${invoiceCreatedTasks.length}`,
            "info"
          );
          log(
            `   • Doublons détectés: ${duplicates}`,
            duplicates > 0 ? "error" : "success"
          );

          if (duplicates > 0) {
            log(
              `⚠️  ${duplicates} doublons détectés ! Utilisez le bouton "Nettoyer" pour les supprimer.`,
              "error"
            );
          } else {
            log(`✅ Aucun doublon détecté.`, "success");
          }

          // Afficher les détails
          log(`\n📋 Détail des tâches récentes:`, "info");
          recentTasks.forEach((task, index) => {
            log(`   ${index + 1}. ${task.title} - ${task.description}`, "info");
          });
        } catch (error) {
          log(`❌ Erreur lors de l'analyse: ${error.message}`, "error");
        }
      }

      function cleanupDuplicates() {
        log("🧹 Nettoyage des doublons en cours...", "info");

        try {
          const recentTasks = JSON.parse(
            localStorage.getItem("facturly_recent_tasks") || "[]"
          );
          const cleanedTasks = [];
          const seenInvoices = new Set();
          const seenClients = new Set();

          for (const task of recentTasks) {
            let shouldKeep = true;

            if (task.type === "invoice_created") {
              const invoiceNumberMatch =
                task.description.match(/Facture ([^\s]+)/);
              if (invoiceNumberMatch) {
                const invoiceNumber = invoiceNumberMatch[1];
                if (seenInvoices.has(invoiceNumber)) {
                  shouldKeep = false;
                  log(
                    `   🗑️  Suppression du doublon: ${task.description}`,
                    "info"
                  );
                } else {
                  seenInvoices.add(invoiceNumber);
                }
              }
            } else if (task.type === "client_added") {
              const clientNameMatch =
                task.description.match(/Client ([^]+) ajouté/);
              if (clientNameMatch) {
                const clientName = clientNameMatch[1];
                if (seenClients.has(clientName)) {
                  shouldKeep = false;
                  log(
                    `   🗑️  Suppression du doublon: ${task.description}`,
                    "info"
                  );
                } else {
                  seenClients.add(clientName);
                }
              }
            }

            if (shouldKeep) {
              cleanedTasks.push(task);
            }
          }

          localStorage.setItem(
            "facturly_recent_tasks",
            JSON.stringify(cleanedTasks)
          );

          const removedCount = recentTasks.length - cleanedTasks.length;
          log(`✅ Nettoyage terminé !`, "success");
          log(`   • Tâches avant: ${recentTasks.length}`, "info");
          log(`   • Tâches après: ${cleanedTasks.length}`, "info");
          log(`   • Doublons supprimés: ${removedCount}`, "success");

          if (removedCount > 0) {
            log(
              `🔄 Rechargez la page du dashboard pour voir les changements.`,
              "info"
            );
          }
        } catch (error) {
          log(`❌ Erreur lors du nettoyage: ${error.message}`, "error");
        }
      }

      function clearAllTasks() {
        if (
          confirm(
            "⚠️ Êtes-vous sûr de vouloir supprimer TOUTES les activités récentes ?"
          )
        ) {
          localStorage.removeItem("facturly_recent_tasks");
          log(
            `🗑️ Toutes les activités récentes ont été supprimées.`,
            "success"
          );
          log(
            `🔄 Rechargez la page du dashboard pour voir les changements.`,
            "info"
          );
        }
      }

      // Analyse automatique au chargement
      window.onload = () => {
        log("🚀 Outil de nettoyage des doublons chargé", "success");
        analyzeData();
      };
    </script>
  </body>
</html>
